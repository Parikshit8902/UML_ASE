<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UML Editor with AI Feedback</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        iframe { width: 90%; height: 500px; border: 1px solid #ddd; }
        button { margin-top: 10px; padding: 10px; font-size: 16px; cursor: pointer; }
        #feedback { margin-top: 20px; font-weight: bold; color: blue; }
    </style>
</head>
<body>

    <h2>UML Diagram Editor with AI Feedback</h2>
    
    <!-- Embedding Draw.io -->
    <iframe id="drawioFrame" src="https://embed.diagrams.net/?embed=1&ui=dark"></iframe>
    
    <br>
    <button onclick="getDiagramXML()">Get AI Feedback</button>
    <p id="feedback"></p>

    <script>
        function getDiagramXML() {
            var iframe = document.getElementById("drawioFrame").contentWindow;
            iframe.postMessage({ action: "export", format: "xml" }, "*");
        }

        window.addEventListener("message", async function(event) {
    var msg = event.data;

    if (msg && msg.action === "export" && typeof msg.data === "string") {
        let xmlData = msg.data.trim(); // Ensure it's a proper string

        if (!xmlData.startsWith("<mxGraphModel")) {  
            console.error("Invalid XML format:", xmlData);
            document.getElementById("feedback").innerText = "Error: Invalid diagram file format.";
            return;
        }

        try {
            let response = await fetch("http://localhost:8000/analyze_diagram", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ xml: xmlData })
            });

            let data = await response.json();
            document.getElementById("feedback").innerText = "AI Feedback: " + data.feedback;
        } catch (error) {
            console.error("Error fetching AI feedback:", error);
            document.getElementById("feedback").innerText = "Error fetching AI feedback.";
        }
    } else {
        console.error("Invalid response from Draw.io:", msg);
    }
});
    </script>

</body>
</html>
